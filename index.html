<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">

    <title>VIRTUS ULTIMATE PRO | Cloud</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILOS ORIGINAIS DO VIRTUS PRO --- */
        :root {
            --bg-dark: #0a0a0f;
            --bg-medium: #13131a;
            --sidebar-bg: #0f0f14;
            --card-bg: #1a1a24;
            --card-hover: #1f1f2e;
            --text-main: #f5f5f7;
            --text-dim: #9999a8;
            --text-muted: #5d5d6b;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-dark); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }

        /* TELA DE LOGIN (NOVO) */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 20000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .auth-card {
            width: 100%; max-width: 400px;
            background: var(--card-bg); padding: 40px; border-radius: 24px;
            border: 1px solid var(--sidebar-bg); box-shadow: 0 0 50px rgba(0, 212, 255, 0.1);
            text-align: center;
        }
        .auth-logo {
            font-size: 3rem; margin-bottom: 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-family: 'Space Mono', monospace; font-weight: 700;
        }

        /* LAYOUT PRINCIPAL (ESCONDIDO AT√â LOGAR) */
        .app-wrapper { display: none; min-height: 100vh; }
        
        /* SIDEBAR & NAV */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid #2a2a38; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 1000; padding-top: var(--safe-area-top); transition: transform 0.3s ease; }
        .logo-area { padding: 32px 28px; border-bottom: 1px solid #2a2a38; display: flex; align-items: center; gap: 14px; }
        .logo-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .logo-text { font-family: 'Space Mono'; font-weight: 700; font-size: 1.6rem; letter-spacing: 2px; color: white; }
        
        .nav-menu { list-style: none; padding: 20px 12px; flex: 1; overflow-y: auto; }
        .nav-item { padding: 14px 20px; margin-bottom: 6px; display: flex; align-items: center; gap: 14px; cursor: pointer; color: var(--text-dim); border-radius: 10px; transition: 0.2s; }
        .nav-item.active { background: rgba(0, 212, 255, 0.12); color: var(--accent-primary); font-weight: 600; }
        
        /* CONTE√öDO */
        .main-content { flex: 1; margin-left: 280px; padding: 32px; padding-top: calc(32px + var(--safe-area-top)); }
        
        /* Mobile Toggle */
        .mobile-menu-btn { display: none; position: fixed; top: 20px; left: 20px; z-index: 1001; background: var(--card-bg); border: 1px solid #333; padding: 12px 16px; border-radius: 10px; color: white; }

        /* UI ELEMENTS */
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3); }
        .btn-secondary { background: var(--card-bg); color: white; border: 1px solid #333; }
        .btn-danger { background: var(--accent-danger); color: white; }
        .btn-icon { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 5px; }
        .btn-icon:hover { color: white; }

        .form-input, .form-select { width: 100%; background: var(--card-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 5px; }
        .form-group { margin-bottom: 12px; }
        .form-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* CARDS & GRIDS */
        .section-box { background: var(--card-bg); border: 1px solid #2a2a38; border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .kpi-card { background: var(--card-bg); border: 1px solid #2a2a38; border-radius: 16px; padding: 24px; }
        .kpi-value { font-size: 2rem; font-weight: 700; font-family: 'Space Mono'; margin-top: 10px; }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* LOADER */
        .loader { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* TOAST */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--card-bg); border-left: 4px solid var(--accent-success); padding: 16px 20px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color: white; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 100%; max-width: 300px; }
            .sidebar.mobile-visible { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; padding: 80px 20px 40px; }
            .mobile-menu-btn { display: block; }
        }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <div class="auth-logo">VIRTUS</div>
            <p style="color: var(--text-dim); margin-bottom: 30px;">
                <i class="fa-solid fa-cloud"></i> Ultimate Pro Cloud
            </p>
            <form id="login-form">
                <div class="form-group">
                    <input type="email" id="email" class="form-input" placeholder="Seu E-mail" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" class="form-input" placeholder="Sua Senha" required>
                </div>
                <button type="submit" class="btn btn-primary" id="btn-login">
                    <span class="btn-text">Entrar / Criar Conta</span>
                    <div class="loader"></div>
                </button>
            </form>
            <p style="margin-top: 20px; font-size: 0.8rem; color: var(--text-dim);">
                A conta ser√° criada automaticamente se n√£o existir.
            </p>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fa-solid fa-bars"></i>
    </button>

    <div class="app-wrapper" id="app-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="logo-area">
                <div class="logo-icon"><i class="fa-solid fa-shield-halved"></i></div>
                <div>
                    <div class="logo-text">VIRTUS</div>
                    <div style="font-size: 0.7rem; color: var(--text-dim);">PRO CLOUD</div>
                </div>
            </div>

            <div style="padding: 10px 20px; border-bottom: 1px solid #2a2a38;">
                <small style="color: var(--accent-success);"><i class="fa-solid fa-wifi"></i> Online</small>
                <div id="user-display" style="font-size: 0.8rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item active" onclick="switchTab(event, 'home')"><i class="fa-solid fa-chart-pie"></i> <span>Dashboard</span></li>
                <li class="nav-item" onclick="switchTab(event, 'investimentos')"><i class="fa-solid fa-chart-line"></i> <span>Investimentos</span></li>
                <li class="nav-item" onclick="switchTab(event, 'fixas')"><i class="fa-solid fa-file-invoice-dollar"></i> <span>Contas Fixas</span></li>
                <li class="nav-item" onclick="switchTab(event, 'diarios')"><i class="fa-solid fa-calendar-day"></i> <span>Gastos Di√°rios</span></li>
                <li class="nav-item" onclick="switchTab(event, 'parcelados')"><i class="fa-solid fa-credit-card"></i> <span>Parcelados</span></li>
                <li class="nav-item" onclick="switchTab(event, 'metas')"><i class="fa-solid fa-bullseye"></i> <span>Metas</span></li>
                <li class="nav-item" onclick="switchTab(event, 'relatorios')"><i class="fa-solid fa-chart-bar"></i> <span>Relat√≥rios</span></li>
            </ul>

            <div style="padding: 20px; border-top: 1px solid #2a2a38;">
                <button class="btn btn-secondary" onclick="logoutApp()">
                    <i class="fa-solid fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div id="home" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h1 class="page-title" style="font-size: 2rem; font-weight: 700;">Vis√£o Geral</h1>
                    <button class="btn btn-secondary" style="width: auto;" onclick="atualizarTudo()">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <span class="form-label">SALDO LIVRE</span>
                        <div class="kpi-value" id="h-saldo" style="color: var(--accent-primary);">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <span class="form-label">INVESTIDO</span>
                        <div class="kpi-value" id="h-invest" style="color: var(--accent-secondary);">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <span class="form-label">PATRIM√îNIO</span>
                        <div class="kpi-value" id="h-patri" style="color: var(--accent-success);">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <span class="form-label">DESPESAS M√äS</span>
                        <div class="kpi-value" id="h-despesa" style="color: var(--accent-danger);">R$ 0,00</div>
                    </div>
                </div>

                <div class="section-box">
                    <h2 style="margin-bottom: 20px;">Lan√ßamento R√°pido</h2>
                    <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" id="f-desc" class="form-input" placeholder="Descri√ß√£o">
                        <input type="number" id="f-valor" class="form-input" placeholder="Valor" step="0.01">
                        <input type="date" id="f-data" class="form-input">
                        <select id="f-tipo" class="form-select">
                            <option value="Receita">üí∞ Receita</option>
                            <option value="Di√°rio">‚òï Gasto Di√°rio</option>
                            <option value="Fixo">üè† Conta Fixa</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="adicionarGeral()">Adicionar</button>
                </div>
            </div>

            <div id="investimentos" class="tab-content">
                <h1 style="margin-bottom: 20px; font-size: 2rem; font-weight: 700;">Investimentos</h1>
                <div class="section-box">
                    <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" id="i-onde" class="form-input" placeholder="Ativo (Ex: CDB, A√ß√µes)">
                        <input type="number" id="i-valor" class="form-input" placeholder="Valor Investido">
                        <input type="number" id="i-taxa" class="form-input" placeholder="Taxa Mensal %">
                        <select id="i-tipo" class="form-select">
                            <option value="Renda Fixa">Renda Fixa</option>
                            <option value="A√ß√µes">A√ß√µes</option>
                            <option value="FIIs">FIIs</option>
                            <option value="Cripto">Cripto</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="adicionarInvest()">Novo Investimento</button>
                </div>
                <div class="section-box" id="lista-invest">
                    <p style="color: var(--text-dim); text-align: center;">Carregando...</p>
                </div>
            </div>

            <div id="fixas" class="tab-content">
                <h1 style="margin-bottom: 20px; font-size: 2rem; font-weight: 700;">Contas Fixas</h1>
                <div class="section-box">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="fix-desc" class="form-input" placeholder="Descri√ß√£o (Ex: Aluguel)">
                        <input type="number" id="fix-valor" class="form-input" placeholder="Valor">
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="adicionarFixa()">Adicionar Fixa</button>
                </div>
                <div class="section-box" id="lista-fixas"></div>
            </div>

            <div id="diarios" class="tab-content">
                <h1 style="margin-bottom: 20px; font-size: 2rem; font-weight: 700;">Gastos Di√°rios</h1>
                <div class="section-box">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" id="dia-desc" class="form-input" placeholder="Descri√ß√£o">
                        <input type="number" id="dia-valor" class="form-input" placeholder="Valor">
                        <select id="dia-forma" class="form-select">
                            <option value="PIX">PIX</option>
                            <option value="D√©bito">D√©bito</option>
                            <option value="Cr√©dito">Cr√©dito</option>
                            <option value="Dinheiro">Dinheiro</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="adicionarDiario()">Registrar Gasto</button>
                </div>
                <div class="section-box" id="t-diarios"></div>
            </div>

            <div id="parcelados" class="tab-content">
                <h1 style="margin-bottom: 20px; font-size: 2rem; font-weight: 700;">Parcelados</h1>
                <div class="section-box">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" id="parc-desc" class="form-input" placeholder="Compra">
                        <input type="number" id="parc-total" class="form-input" placeholder="Valor TOTAL">
                        <input type="number" id="parc-qtd" class="form-input" placeholder="N¬∫ Parcelas">
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="adicionarParcelado()">Criar Parcelamento</button>
                </div>
                <div class="section-box" id="t-parcelados"></div>
            </div>

            <div id="metas" class="tab-content">
                <h1 style="margin-bottom: 20px; font-size: 2rem; font-weight: 700;">Metas</h1>
                <div class="section-box">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" id="meta-nome" class="form-input" placeholder="Objetivo">
                        <input type="number" id="meta-valor" class="form-input" placeholder="Valor Alvo">
                        <input type="number" id="meta-atual" class="form-input" placeholder="J√° guardado" value="0">
                        <input type="date" id="meta-data" class="form-input">
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="adicionarMeta()">Definir Meta</button>
                </div>
                <div id="lista-metas"></div>
            </div>

            <div id="relatorios" class="tab-content">
                <h1 style="margin-bottom: 20px; font-size: 2rem; font-weight: 700;">Relat√≥rios</h1>
                <div class="section-box">
                    <canvas id="mainChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        // --- 1. CONFIGURA√á√ÉO DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // SUAS CHAVES (J√° inseridas)
        const firebaseConfig = {
            apiKey: "AIzaSyDw6w_GjiNA9Pexxxt8HMZEnmH_kUJpEtc",
            authDomain: "virtusapp-c3810.firebaseapp.com",
            projectId: "virtusapp-c3810",
            storageBucket: "virtusapp-c3810.firebasestorage.app",
            messagingSenderId: "947824991501",
            appId: "1:947824991501:web:a99c301848af36691a6444",
            measurementId: "G-7VPGDDZLVF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbCloud = getFirestore(app);

        // --- 2. VARI√ÅVEIS GLOBAIS ---
        let db = { trans: [], invest: [], metas: [] };
        let currentUser = null;
        let chartInstance = null;

        // --- 3. FUN√á√ïES DE SISTEMA (Auth & Cloud) ---
        
        // Login Logic
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btn-login');
            
            // Loading UI
            const txt = btn.querySelector('.btn-text');
            const spin = btn.querySelector('.loader');
            txt.style.display='none'; spin.style.display='block'; btn.disabled=true;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                if(err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                        showToast('Conta criada com sucesso!');
                    } catch(e2) { alert("Erro ao criar: " + e2.message); }
                } else {
                    alert("Erro: " + err.message);
                }
            }
            txt.style.display='block'; spin.style.display='none'; btn.disabled=false;
        });

        // Auth Monitor
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-wrapper').style.display = 'flex';
                document.querySelector('.mobile-menu-btn').style.display = 'block';
                document.getElementById('user-display').innerText = user.email;
                await carregarCloud();
            } else {
                currentUser = null;
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-wrapper').style.display = 'none';
                document.querySelector('.mobile-menu-btn').style.display = 'none';
            }
        });

        async function carregarCloud() {
            if(!currentUser) return;
            const docRef = doc(dbCloud, "usuarios", currentUser.uid);
            const snap = await getDoc(docRef);
            if(snap.exists()) {
                db = snap.data();
            } else {
                db = { trans: [], invest: [], metas: [] };
                salvarCloud();
            }
            atualizarTudo();
        }

        async function salvarCloud() {
            if(!currentUser) return;
            const docRef = doc(dbCloud, "usuarios", currentUser.uid);
            await setDoc(docRef, db, { merge: true });
            atualizarTudo(); // Refresh UI
        }

        // --- 4. FUN√á√ïES DO VIRTUS PRO (Adaptadas para Window) ---
        
        // Expor fun√ß√µes para o HTML poder clicar
        window.switchTab = function(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(event) event.currentTarget.classList.add('active');
            
            // Mobile close
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('mobile-visible');
        };

        window.toggleMobileMenu = function() {
            document.getElementById('sidebar').classList.toggle('mobile-visible');
        };

        window.logoutApp = function() {
            if(confirm("Sair do sistema?")) signOut(auth);
        };

        // ADICIONAR
        window.adicionarGeral = function() {
            const desc = document.getElementById('f-desc').value;
            const valor = parseFloat(document.getElementById('f-valor').value);
            const data = document.getElementById('f-data').value;
            const tipo = document.getElementById('f-tipo').value;
            
            if(!desc || !valor || !data) return alert("Preencha tudo!");
            
            db.trans.push({ desc, valor, data, tipo, parc: 1, pago: false });
            salvarCloud();
            showToast("Lan√ßamento salvo!");
            
            // Limpar
            document.getElementById('f-desc').value = '';
            document.getElementById('f-valor').value = '';
        };

        window.adicionarInvest = function() {
            db.invest.push({
                onde: document.getElementById('i-onde').value,
                valor: parseFloat(document.getElementById('i-valor').value),
                taxa: parseFloat(document.getElementById('i-taxa').value)/100,
                tipo: document.getElementById('i-tipo').value
            });
            salvarCloud();
            showToast("Investimento salvo!");
        };

        window.adicionarFixa = function() {
            db.trans.push({
                desc: document.getElementById('fix-desc').value,
                valor: parseFloat(document.getElementById('fix-valor').value),
                tipo: 'Fixo', data: new Date().toISOString(), pago: false
            });
            salvarCloud();
        };

        window.adicionarDiario = function() {
            db.trans.push({
                desc: document.getElementById('dia-desc').value,
                valor: parseFloat(document.getElementById('dia-valor').value),
                tipo: 'Di√°rio', 
                forma: document.getElementById('dia-forma').value,
                data: new Date().toISOString(), pago: true
            });
            salvarCloud();
        };

        window.adicionarParcelado = function() {
            db.trans.push({
                desc: document.getElementById('parc-desc').value,
                valor: parseFloat(document.getElementById('parc-total').value),
                parc: parseInt(document.getElementById('parc-qtd').value),
                parc_pagas: 0,
                tipo: 'Parcelado', data: new Date().toISOString()
            });
            salvarCloud();
        };

        window.adicionarMeta = function() {
            if(!db.metas) db.metas = [];
            db.metas.push({
                nome: document.getElementById('meta-nome').value,
                valor: parseFloat(document.getElementById('meta-valor').value),
                atual: parseFloat(document.getElementById('meta-atual').value),
                data: document.getElementById('meta-data').value
            });
            salvarCloud();
        };

        // REMOVER / ACOES
        window.remover = function(tipo, index) {
            if(confirm("Apagar item?")) {
                if(tipo === 'trans') db.trans.splice(index, 1);
                if(tipo === 'invest') db.invest.splice(index, 1);
                if(tipo === 'meta') db.metas.splice(index, 1);
                salvarCloud();
            }
        };

        window.pagarParcela = function(index) {
            if(db.trans[index].parc_pagas < db.trans[index].parc) {
                db.trans[index].parc_pagas++;
                salvarCloud();
            }
        };

        // --- 5. ATUALIZAR UI (Renderiza√ß√£o) ---
        window.atualizarTudo = function() {
            let saldo = 0, invest = 0, despesa = 0;
            const mesAtual = new Date().getMonth();

            // Listas
            const lFixas = document.getElementById('lista-fixas'); lFixas.innerHTML = '';
            const lDiarios = document.getElementById('t-diarios'); lDiarios.innerHTML = '';
            const lParc = document.getElementById('t-parcelados'); lParc.innerHTML = '';
            const lInvest = document.getElementById('lista-invest'); lInvest.innerHTML = '';
            const lMetas = document.getElementById('lista-metas'); lMetas.innerHTML = '';

            // Processar Transa√ß√µes
            db.trans.forEach((t, i) => {
                const val = parseFloat(t.valor);
                
                if(t.tipo === 'Receita') {
                    saldo += val;
                } else if(t.tipo === 'Fixo') {
                    despesa += val;
                    lFixas.innerHTML += criarItemHTML(t.desc, val, 'trans', i);
                } else if(t.tipo === 'Di√°rio') {
                    despesa += val;
                    lDiarios.innerHTML += criarItemHTML(t.desc + ` (${t.forma})`, val, 'trans', i);
                } else if(t.tipo === 'Parcelado') {
                    const valParc = val / t.parc;
                    despesa += valParc; // Conta s√≥ a parcela do m√™s
                    const prog = (t.parc_pagas / t.parc * 100).toFixed(0);
                    
                    lParc.innerHTML += `
                        <div class="section-box" style="padding: 15px;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${t.desc}</strong>
                                <span>${t.parc_pagas}/${t.parc}</span>
                            </div>
                            <div style="background:#333; height:5px; border-radius:5px; margin:5px 0;">
                                <div style="background:var(--accent-secondary); width:${prog}%; height:100%;"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                                <small>R$ ${valParc.toFixed(2)}/m√™s</small>
                                <div>
                                    <button class="btn-icon" onclick="pagarParcela(${i})"><i class="fa-solid fa-plus-circle"></i></button>
                                    <button class="btn-icon" style="color:red" onclick="remover('trans', ${i})"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            // Processar Investimentos
            db.invest.forEach((inv, i) => {
                invest += inv.valor;
                lInvest.innerHTML += criarItemHTML(inv.onde, inv.valor, 'invest', i, inv.tipo);
            });

            // Processar Metas
            if(db.metas) {
                db.metas.forEach((m, i) => {
                    const prog = (m.atual / m.valor * 100).toFixed(0);
                    lMetas.innerHTML += `
                        <div class="section-box" style="padding: 15px;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${m.nome}</strong>
                                <button class="btn-icon" onclick="remover('meta', ${i})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <div style="background:#333; height:8px; border-radius:5px; margin:8px 0;">
                                <div style="background:var(--accent-success); width:${prog}%; height:100%;"></div>
                            </div>
                            <div style="text-align:right; font-size:0.8rem;">${formatar(m.atual)} / ${formatar(m.valor)}</div>
                        </div>
                    `;
                });
            }

            // Atualizar KPIs
            saldo = saldo - despesa; // Saldo real
            document.getElementById('h-saldo').innerText = formatar(saldo);
            document.getElementById('h-invest').innerText = formatar(invest);
            document.getElementById('h-despesa').innerText = formatar(despesa);
            document.getElementById('h-patri').innerText = formatar(saldo + invest);

            renderChart(saldo, invest, despesa);
        };

        function criarItemHTML(texto, valor, tipo, index, extra='') {
            return `
                <div style="display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #333; align-items: center;">
                    <div>
                        <div style="font-weight: 600;">${texto}</div>
                        ${extra ? `<small style="color:var(--accent-primary)">${extra}</small>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div>${formatar(valor)}</div>
                        <button class="btn-icon" style="color: var(--accent-danger); font-size:0.8rem;" onclick="remover('${tipo}', ${index})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function formatar(v) { return v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }

        window.showToast = function(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${msg}`;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        function renderChart(s, i, d) {
            const ctx = document.getElementById('mainChart');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Saldo', 'Investido', 'Despesas'],
                    datasets: [{
                        data: [s>0?s:0, i, d],
                        backgroundColor: ['#00d4ff', '#7c3aed', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
            });
        }

        // Init Data
        document.getElementById('f-data').valueAsDate = new Date();
        document.getElementById('meta-data').valueAsDate = new Date();

    </script>
</body>
</html>
